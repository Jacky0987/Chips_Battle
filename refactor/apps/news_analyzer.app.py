"""
æ–°é—»åˆ†æå™¨åº”ç”¨ - ç‹¬ç«‹åº”ç”¨æ¨¡å—
"""

import random
from datetime import datetime, timedelta
from apps.base_app import BaseApp


class NewsAnalyzerApp(BaseApp):
    """æ–°é—»åˆ†æå™¨åº”ç”¨"""
    
    def __init__(self):
        super().__init__(
            "news_analyzer",
            "ğŸ“° æ–°é—»åˆ†æå™¨",
            "AIé©±åŠ¨çš„å¸‚åœºæ–°é—»åˆ†æå·¥å…·ï¼Œæ·±åº¦è§£è¯»å½±å“è‚¡ä»·çš„å…³é”®ä¿¡æ¯",
            12000,
            "åˆ†æå·¥å…·"
        )
    
    def run(self, main_app, action=None):
        """è¿è¡Œæ–°é—»åˆ†æå™¨"""
        self.update_usage()
        
        if action is None:
            return self._show_news_menu(main_app)
        
        if action.lower() == 'daily':
            return self._daily_news_analysis(main_app)
        elif action.lower() == 'sentiment':
            return self._market_sentiment_analysis(main_app)
        elif action.lower() == 'events':
            return self._event_impact_analysis(main_app)
        else:
            return "âŒ æ— æ•ˆæ“ä½œï¼Œè¯·ä½¿ç”¨ daily, sentiment, æˆ– events"
    
    def _daily_news_analysis(self, main_app):
        """æ¯æ—¥æ–°é—»åˆ†æ"""
        analysis_text = f"""
ğŸ“° æ¯æ—¥æ–°é—»åˆ†ææŠ¥å‘Š
{datetime.now().strftime('%Y-%m-%d %H:%M')}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                ğŸ—ï¸  ä»Šæ—¥å¸‚åœºè¦é—»  ğŸ—ï¸                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š å¸‚åœºæƒ…ç»ªæŒ‡æ•°: {random.randint(35, 85)}% (0%ææ…Œ - 100%ç‹‚çƒ­)
ğŸŒ¡ï¸ æ³¢åŠ¨ç‡é¢„æœŸ: {random.choice(['ä½', 'ä¸­ç­‰', 'åé«˜', 'é«˜'])}
ğŸ“ˆ ä¸»å¯¼è¶‹åŠ¿: {random.choice(['ä¸Šæ¶¨', 'éœ‡è¡', 'è°ƒæ•´', 'æ•´ç†'])}

ğŸ”¥ çƒ­ç‚¹æ–°é—»å½±å“åˆ†æ:

1. ğŸ“ˆ å¤®è¡Œæ”¿ç­–åŠ¨å‘
   â¤ å½±å“åº¦: â­â­â­â­â­
   â¤ åˆ©å¥½æ¿å—: é“¶è¡Œã€åœ°äº§ã€åŸºå»º
   â¤ é¢„æœŸå½±å“: æµåŠ¨æ€§æ”¹å–„ï¼Œä¼°å€¼æå‡
   â¤ å»ºè®®å…³æ³¨: å¤§å‹é“¶è¡Œè‚¡ã€æˆ¿åœ°äº§é¾™å¤´

2. ğŸ­ åˆ¶é€ ä¸šæ•°æ®å‘å¸ƒ  
   â¤ å½±å“åº¦: â­â­â­â­
   â¤ æ•°æ®è¡¨ç°: {random.choice(['è¶…é¢„æœŸ', 'ç¬¦åˆé¢„æœŸ', 'ç•¥ä½äºé¢„æœŸ'])}
   â¤ ç›¸å…³æ¿å—: å·¥ä¸šã€åŸææ–™ã€å‡ºå£
   â¤ æŠ•èµ„å»ºè®®: å…³æ³¨åˆ¶é€ ä¸šå‡çº§æ¦‚å¿µè‚¡

3. ğŸŒ ç§‘æŠ€è‚¡è´¢æŠ¥å­£
   â¤ å½±å“åº¦: â­â­â­â­â­  
   â¤ æ•´ä½“è¡¨ç°: åˆ†åŒ–æ˜æ˜¾ï¼Œå¤´éƒ¨ä¼ä¸šè¡¨ç°äº®çœ¼
   â¤ å…³é”®æŒ‡æ ‡: ç”¨æˆ·å¢é•¿ã€ç›ˆåˆ©èƒ½åŠ›ã€åˆ›æ–°æŠ•å…¥
   â¤ æŠ•èµ„ç­–ç•¥: ç²¾é€‰ä¼˜è´¨ç§‘æŠ€è‚¡ï¼Œé¿å…ç‚’ä½œæ ‡çš„

ğŸ¯ ä»Šæ—¥äº¤æ˜“å»ºè®®:

âœ… çœ‹å¥½æ–¹å‘:
â€¢ æ–°èƒ½æºæ±½è½¦äº§ä¸šé“¾ (æ”¿ç­–æ”¯æŒæŒç»­)
â€¢ åŒ»ç–—å¥åº·æ¿å— (äººå£è€é¾„åŒ–è¶‹åŠ¿)  
â€¢ é«˜ç«¯åˆ¶é€ ä¸š (äº§ä¸šå‡çº§éœ€æ±‚)

âš ï¸ è°¨æ…å…³æ³¨:
â€¢ ä¼ ç»Ÿé›¶å”®ä¸š (çº¿ä¸Šå†²å‡»æŒç»­)
â€¢ æˆ¿åœ°äº§å¼€å‘ (æ”¿ç­–è°ƒæ§å½±å“)
â€¢ èµ„æºç±»è‚¡ç¥¨ (ä»·æ ¼æ³¢åŠ¨é£é™©)

ğŸ” é£é™©æç¤º:
â€¢ åœ°ç¼˜æ”¿æ²»ç´§å¼ å±€åŠ¿
â€¢ é€šèƒ€é¢„æœŸå˜åŒ–
â€¢ æ±‡ç‡æ³¢åŠ¨å½±å“
â€¢ ç›‘ç®¡æ”¿ç­–è°ƒæ•´

ğŸ“ åˆ†æå¸ˆè§‚ç‚¹:
å½“å‰å¸‚åœºå¤„äºç»“æ„æ€§è¡Œæƒ…ä¸­ï¼ŒæŠ•èµ„è€…åº”æ³¨é‡ä¸ªè‚¡åŸºæœ¬é¢åˆ†æï¼Œ
é¿å…ç›²ç›®è¿½æ¶¨æ€è·Œã€‚å»ºè®®å…³æ³¨ä¸šç»©ç¡®å®šæ€§å¼ºã€ä¼°å€¼åˆç†çš„ä¼˜è´¨æ ‡çš„ã€‚

ğŸ’¡ æ˜æ—¥å…³æ³¨è¦ç‚¹:
â€¢ é‡è¦ç»æµæ•°æ®å‘å¸ƒ
â€¢ å¤®è¡Œå…¬å¼€å¸‚åœºæ“ä½œ
â€¢ ä¸Šå¸‚å…¬å¸ä¸šç»©å…¬å‘Š
â€¢ å›½é™…å¸‚åœºè”åŠ¨å½±å“

æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚
"""
        return analysis_text
    
    def _market_sentiment_analysis(self, main_app):
        """å¸‚åœºæƒ…ç»ªåˆ†æ"""
        sentiment_score = random.randint(20, 90)
        
        if sentiment_score >= 80:
            sentiment_level = "æåº¦ä¹è§‚"
            sentiment_color = "ğŸŸ¢"
            warning = "âš ï¸ å¸‚åœºå¯èƒ½è¿‡çƒ­ï¼Œæ³¨æ„é£é™©"
        elif sentiment_score >= 60:
            sentiment_level = "ä¹è§‚"
            sentiment_color = "ğŸŸ¢"
            warning = "ğŸ’¡ é€‚åˆç§¯ææŠ•èµ„ï¼Œä½†éœ€æ§åˆ¶ä»“ä½"
        elif sentiment_score >= 40:
            sentiment_level = "ä¸­æ€§"
            sentiment_color = "ğŸŸ¡"
            warning = "ğŸ“Š å¸‚åœºå¹³è¡¡ï¼Œé€‚åˆè§‚æœ›æˆ–å¹³è¡¡é…ç½®"
        elif sentiment_score >= 20:
            sentiment_level = "æ‚²è§‚"
            sentiment_color = "ğŸŸ "
            warning = "ğŸ” å¯èƒ½å­˜åœ¨è¶…è·Œæœºä¼šï¼Œè°¨æ…æŠ„åº•"
        else:
            sentiment_level = "æåº¦ææ…Œ"
            sentiment_color = "ğŸ”´"
            warning = "ğŸ’ å†å²åº•éƒ¨åŒºåŸŸï¼Œé•¿æœŸæŠ•èµ„æœºä¼š"
        
        return f"""
ğŸ“Š å¸‚åœºæƒ…ç»ªæ·±åº¦åˆ†æ

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                               ğŸ’­ æƒ…ç»ªåˆ†æé›·è¾¾ ğŸ’­                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŒ¡ï¸ ç»¼åˆæƒ…ç»ªæŒ‡æ•°: {sentiment_color} {sentiment_score}/100 ({sentiment_level})

ğŸ“ˆ æƒ…ç»ªæ„æˆåˆ†æ:
â”œâ”€ ğŸ“° æ–°é—»æƒ…ç»ª: {random.randint(30, 90)}/100  
â”œâ”€ ğŸ’¬ ç¤¾äº¤åª’ä½“: {random.randint(20, 85)}/100
â”œâ”€ ğŸ“Š èµ„é‡‘æµå‘: {random.randint(25, 95)}/100
â”œâ”€ ğŸ›ï¸ æœºæ„æ€åº¦: {random.randint(40, 80)}/100
â””â”€ ğŸŒ å›½é™…å¸‚åœº: {random.randint(35, 75)}/100

ğŸ¯ å…³é”®æƒ…ç»ªæŒ‡æ ‡:

â€¢ VIXææ…ŒæŒ‡æ•°: {random.uniform(15, 45):.1f} ({'ä½ææ…Œ' if random.random() > 0.6 else 'ä¸­ç­‰ææ…Œ' if random.random() > 0.3 else 'é«˜ææ…Œ'})
â€¢ æ¶¨è·Œæ¯”ä¾‹: {random.randint(30, 70)}% (ä¸Šæ¶¨è‚¡ç¥¨å æ¯”)
â€¢ æ¢æ‰‹ç‡: {random.uniform(1.2, 4.8):.1f}% ({'æ´»è·ƒ' if random.random() > 0.5 else 'å¹³æ·¡'})
â€¢ èèµ„ä½™é¢å˜åŒ–: {random.choice(['+', '-'])}{random.uniform(0.1, 2.5):.1f}%

ğŸ”„ æƒ…ç»ªå‘¨æœŸåˆ¤æ–­:
å½“å‰ä½ç½®: {random.choice(['åº•éƒ¨åè½¬', 'ä¸Šå‡è¶‹åŠ¿', 'é¡¶éƒ¨éœ‡è¡', 'ä¸‹é™è°ƒæ•´', 'æ¨ªç›˜æ•´ç†'])}
é¢„æœŸæŒç»­: {random.randint(3, 15)}ä¸ªäº¤æ˜“æ—¥

ğŸ’° æŠ•èµ„ç­–ç•¥å»ºè®®:
{warning}

ğŸ“Š å†å²å¯¹æ¯”:
â€¢ å½“å‰æƒ…ç»ª vs 30æ—¥å‡å€¼: {random.choice(['+', '-'])}{random.randint(5, 25)}%
â€¢ æœ¬æœˆæƒ…ç»ªæ³¢åŠ¨å¹…åº¦: {random.randint(15, 45)}%
â€¢ å¹´å†…æå€¼åŒºé—´: {random.randint(15, 30)}-{random.randint(70, 95)}

ğŸª å¸‚åœºé£æ ¼åå¥½:
âœ… ä»·å€¼æŠ•èµ„: {'ğŸ”¥' if sentiment_score < 50 else 'â„ï¸'}
âœ… æˆé•¿æŠ•èµ„: {'ğŸ”¥' if sentiment_score > 60 else 'â„ï¸'}  
âœ… é¢˜æç‚’ä½œ: {'ğŸ”¥' if sentiment_score > 70 else 'â„ï¸'}
âœ… é˜²å¾¡é…ç½®: {'ğŸ”¥' if sentiment_score < 40 else 'â„ï¸'}

æ³¨æ„ï¼šæƒ…ç»ªåˆ†æåŸºäºå¤šç»´åº¦æ•°æ®ï¼Œä»…ä¾›å‚è€ƒã€‚
"""
    
    def _event_impact_analysis(self, main_app):
        """äº‹ä»¶å½±å“åˆ†æ"""
        events = [
            {
                'title': 'å¤®è¡Œé™å‡†0.5ä¸ªç™¾åˆ†ç‚¹',
                'impact': 'é‡å¤§åˆ©å¥½',
                'sectors': ['é“¶è¡Œ', 'åœ°äº§', 'åŸºå»º'],
                'probability': 85,
                'timeframe': '1-3ä¸ªæœˆ'
            },
            {
                'title': 'æ–°èƒ½æºæ±½è½¦è¡¥è´´æ”¿ç­–å»¶ç»­',
                'impact': 'è¡Œä¸šåˆ©å¥½',
                'sectors': ['æ±½è½¦', 'ç”µæ± ', 'å……ç”µæ¡©'],
                'probability': 78,
                'timeframe': '6-12ä¸ªæœˆ'
            },
            {
                'title': 'èŠ¯ç‰‡è¿›å£å…³ç¨è°ƒæ•´',
                'impact': 'è´Ÿé¢å½±å“',
                'sectors': ['åŠå¯¼ä½“', 'ç”µå­'],
                'probability': 65,
                'timeframe': '3-6ä¸ªæœˆ'
            },
            {
                'title': 'åŒ»ä¿ç›®å½•æ›´æ–°å‘å¸ƒ',
                'impact': 'ç»“æ„æ€§å½±å“',
                'sectors': ['åŒ»è¯', 'åŒ»ç–—å™¨æ¢°'],
                'probability': 90,
                'timeframe': 'ç«‹å³-1ä¸ªæœˆ'
            }
        ]
        
        selected_events = random.sample(events, 3)
        
        analysis_text = f"""
ğŸ¯ é‡å¤§äº‹ä»¶å½±å“åˆ†æ

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              âš¡ äº‹ä»¶é©±åŠ¨åˆ†æ âš¡                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… åˆ†ææ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M')}
ğŸ” ç›‘æ§äº‹ä»¶: {len(selected_events)}ä¸ªé‡è¦äº‹ä»¶

"""
        
        for i, event in enumerate(selected_events, 1):
            impact_emoji = 'ğŸ“ˆ' if 'åˆ©å¥½' in event['impact'] else 'ğŸ“‰' if 'è´Ÿé¢' in event['impact'] else 'âš¡'
            
            analysis_text += f"""
{i}. {impact_emoji} {event['title']}
   â”œâ”€ å½±å“æ€§è´¨: {event['impact']}
   â”œâ”€ ç›¸å…³æ¿å—: {', '.join(event['sectors'])}
   â”œâ”€ å‘ç”Ÿæ¦‚ç‡: {event['probability']}%
   â”œâ”€ å½±å“å‘¨æœŸ: {event['timeframe']}
   â””â”€ å»ºè®®ç­–ç•¥: {'ç§¯æå¸ƒå±€' if 'åˆ©å¥½' in event['impact'] else 'è§„é¿é£é™©' if 'è´Ÿé¢' in event['impact'] else 'ç»“æ„è°ƒæ•´'}

"""
        
        analysis_text += f"""
ğŸ“Š ç»¼åˆå½±å“è¯„ä¼°:

ğŸ¯ æŠ•èµ„æœºä¼šæ’åº:
1. æ–°èƒ½æºäº§ä¸šé“¾ - æ”¿ç­–æŒç»­æ”¯æŒ
2. é‡‘èåœ°äº§æ¿å— - è´§å¸ç¯å¢ƒæ”¹å–„  
3. åŒ»ç–—å¥åº·é¢†åŸŸ - æ”¿ç­–ç»“æ„ä¼˜åŒ–

âš ï¸ é£é™©å…³æ³¨ç‚¹:
â€¢ ç§‘æŠ€è‚¡é¢ä¸´å¤–éƒ¨å‹åŠ›
â€¢ ä¼ ç»Ÿåˆ¶é€ ä¸šè½¬å‹æŒ‘æˆ˜
â€¢ æ¶ˆè´¹è‚¡éœ€æ±‚æ¢å¤ä¸ç¡®å®š

ğŸ”® æœªæ¥1ä¸ªæœˆé‡ç‚¹å…³æ³¨:
â€¢ è´§å¸æ”¿ç­–æ‰§è¡Œæ•ˆæœ
â€¢ è¡Œä¸šæ”¿ç­–è½åœ°æƒ…å†µ
â€¢ ä¼ä¸šä¸šç»©éªŒè¯è¿›åº¦
â€¢ å¸‚åœºèµ„é‡‘æµå‘å˜åŒ–

ğŸ’¡ äº¤æ˜“å»ºè®®:
åŸºäºäº‹ä»¶é©±åŠ¨çš„æŠ•èµ„æœºä¼šæ˜ç¡®ï¼Œå»ºè®®:
â€¢ æå‰å¸ƒå±€å—ç›Šæ¿å—é¾™å¤´è‚¡
â€¢ è®¾ç½®æ­¢æŸç‚¹æ§åˆ¶é£é™©
â€¢ å…³æ³¨æ”¿ç­–è½åœ°èŠ‚å¥
â€¢ åŠæ—¶è°ƒæ•´ä»“ä½ç»“æ„

é£é™©æç¤º: æ”¿ç­–å˜åŒ–å­˜åœ¨ä¸ç¡®å®šæ€§ï¼ŒæŠ•èµ„å†³ç­–éœ€ç»“åˆä¸ªäººé£é™©æ‰¿å—èƒ½åŠ›ã€‚
"""
        
        return analysis_text
    
    def _show_news_menu(self, main_app):
        """æ˜¾ç¤ºæ–°é—»åˆ†æèœå•"""
        return f"""
ğŸ“° æ–°é—»åˆ†æå™¨

ğŸ’¡ AIé©±åŠ¨çš„æ™ºèƒ½å¸‚åœºåˆ†æå·¥å…·

ğŸ” åˆ†æåŠŸèƒ½:
  appmarket.app news_analyzer daily      # æ¯æ—¥æ–°é—»è¦ç‚¹åˆ†æ
  appmarket.app news_analyzer sentiment  # å¸‚åœºæƒ…ç»ªæ·±åº¦åˆ†æ  
  appmarket.app news_analyzer events     # é‡å¤§äº‹ä»¶å½±å“åˆ†æ

ğŸ“Š åˆ†æä¼˜åŠ¿:
â€¢ å¤šç»´åº¦æ•°æ®æ•´åˆ
â€¢ å®æ—¶æƒ…ç»ªç›‘æ§
â€¢ äº‹ä»¶é©±åŠ¨é¢„æµ‹
â€¢ é£é™©æç¤ºé¢„è­¦

ğŸ¯ é€‚ç”¨åœºæ™¯:
â€¢ æ—¥å†…äº¤æ˜“å†³ç­–æ”¯æŒ
â€¢ ä¸­é•¿æœŸæŠ•èµ„è§„åˆ’
â€¢ é£é™©ç®¡ç†å‚è€ƒ
â€¢ å¸‚åœºè¶‹åŠ¿åˆ¤æ–­

ğŸ“ˆ ä½¿ç”¨ç»Ÿè®¡:
  ä½¿ç”¨æ¬¡æ•°: {self.usage_count}
  
ğŸ’° ä¸“ä¸šç‰ˆåŠŸèƒ½ (å‡çº§å¯è·å¾—):
â€¢ ä¸ªè‚¡æ–°é—»ç›‘æ§
â€¢ è¡Œä¸šå¯¹æ¯”åˆ†æ
â€¢ é‡åŒ–æƒ…ç»ªæŒ‡æ ‡
â€¢ æœºæ„è§‚ç‚¹æ±‡æ€»

ğŸ’¡ æŠ•èµ„æœ‰é£é™©ï¼Œåˆ†æä»…ä¾›å‚è€ƒï¼Œè¯·ç»“åˆè‡ªèº«åˆ¤æ–­åšå‡ºå†³ç­–ã€‚
""" 