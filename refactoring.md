# 《芯片战争：1977》：创世开发史诗 (The Genesis Blueprint)
## 序章：一个“先知”的诞生 (Prologue: Birth of a Prophet)
### 我们的核心愿景
我们不只是在制作一个游戏。我们是在构建一个平行的1977年，一个充满了无限可能性的历史沙盒。玩家，作为掌握着未来科技与信息的“先知”，将是这个世界唯一的变量，是那只扇动翅膀的蝴蝶。我们的使命，是为这只蝴蝶创造一个足够广阔、足够真实、足够深刻的天地，让它掀起的风暴能够撼动整个世界。

### 三大创世基石
1. 1.
   无尽的战略深渊 (The Abyss of Strategy) : 每一个系统都将是深邃的。从一个地区的税率，到一支股票的波动，再到一项技术的突破，所有元素都将通过我们设计的底层逻辑相互关联，相互影响。玩家的每一个决策，都将在深渊中投下石子，激起层层涟漪。
2. 2.
   沉浸的叙事体验 (The Veil of Narrative) : 玩家的“先知”身份是所有设计的灵魂。命令行界面的进化、通过“应用”解锁的超前能力、与时代精英的互动、动态生成的历史新闻……所有的一切都将不断强化这种独一无二的沉浸感。
3. 3.
   无限的模块扩展 (The Pillars of Modularity) : 我们的架构将如宇宙星辰般，在保持核心稳定的前提下，允许无限的扩展。今天我们可以添加一种新的期货合约，明天我们就能引入一个全新的政治派系。这个世界，将与玩家一同成长。
### 史诗的篇章：开发总顺序 (The Epic Chapters: Master Plan)
我们将严格遵循以下篇章顺序，一步步将这个世界从虚无变为现实。每一个新篇章都建立在前一章的坚实基础之上。

- 第一章：开天辟地 (The Cornerstone) - 搭建项目骨架、 全球化数据库模型 与数据访问层。
- 第二章：世界脉搏 (The World's Pulse) - 建立时间、经济与权限三大核心引擎。
- 第三章：神谕之声 (The Oracle's Voice) - 构建灵活、可扩展的统一命令系统。
- 第四章：技术奇点 (The Singularity) - 打造作为核心能力引擎的 应用商店系统 。
- 第五章：不朽传奇 (The Immortal Legend) - 引入事件驱动的 成就与游戏史册系统 。
- 第六章：帝国基石 (The Empire's Foundation) - 构建支持 跨区域运营 和 多市场上市 的公司系统。
- 第七章：金融血脉 (The Financial Bloodline) - 重构支持 多区域业务 的银行、信贷与个人资产系统。
- 第八章：全球市场 (The Global Market) - 建立商品期货与现货市场。
- 第九章：命运之网 (The Web of Fate) - 植入动态事件、关键人物（NPC）关系与媒体舆论系统。
- 第十章：暗影战争 (The Shadow War) - 加入商业谍战与政策游说系统。
- 最终章：世界组装 (The Grand Assembly) - 完成应用总装、UI改造与旧代码净化。
## 第一章：开天辟地 (Chapter I: The Cornerstone)
目标 : 为我们的宇宙设定最基本的物理法则。我们将构建项目的骨架，定义全球化的地理和市场概念，并建立一个强大、可靠的数据库来记录这个世界的一切。

步骤指引 :

1. 1.
   创建项目结构 : 在 refactor/ 目录下，创建 config/ , models/ , dal/ , data/definitions/ 等核心文件夹。
2. 2.
   定义全局配置 :
   - 参考路径 : refactor/config/settings.py
   - 描述 : 在此文件中定义游戏的所有静态配置。包括数据库文件的位置 ( game_database.db )，所有静态定义文件（如地区、市场、成就等）的目录路径，以及游戏开局的默认参数（如起始日期、初始资金）。这将是我们控制世界的第一个旋钮。
3. 3.
   构建全球化数据库模型 :
   - 参考路径 : refactor/models/
   - 描述 : 这是我们世界蓝图的核心。我们将在这里用Python类来定义世界中的万事万物，并通过SQLAlchemy ORM将它们映射到数据库的表中。
     - 地理与市场 ( locations.py ) : 定义 Region 和 Market 两个基础模型。
       - Region 代表一个独立的经济区域。其属性应包含：ID、名称（预留为 [Region_Name_1] , [Region_Name_2] 等）、经济指数、税率、政策稳定性等。
       - Market 代表一个交易市场（如证券交易所）。其属性应包含：ID、名称（预留为 [Market_Name_1] ）、所属 Region 的ID、交易时间、手续费率等。
     - 核心模型的全球化预留 : 在 user.py , company.py , bank.py 等文件中定义的核心模型，都必须包含一个 region_id 字段，用以标记其地理归属。股票模型 Stock 则需包含 market_id 字段，标记其上市地点。
4. 4.
   建立数据访问层 (DAL) :
   - 参考路径 : refactor/dal/
   - 描述 : 这是我们与数据库沟通的唯一渠道，确保了业务逻辑和数据存储的完全分离。
     - 数据库引擎 ( database.py ) : 负责创建和管理到SQLite数据库的连接。它将提供一个全局的会话（Session）对象，供所有的数据读写操作使用。
     - 仓库 ( repositories.py ) : 我们将为每一个核心模型（如User, Company, Region）创建一个对应的仓库类（如 UserRepository , CompanyRepository , LocationRepository ）。这些仓库类封装了所有对数据库的增、删、改、查操作。例如， CompanyRepository 会有 find_by_name 、 find_by_region 等方法。
5. 5.
   填充静态世界定义 :
   - 参考路径 : refactor/data/definitions/
   - 描述 : 在这个目录下的JSON文件中，我们将用您预留的虚拟名称来定义游戏世界的初始状态。
     - regions.json : {"name": "[Region_Name_1]", "tax_rate": 0.2, ...}
     - markets.json : {"name": "[Market_Name_1]", "region": "[Region_Name_1]", ...}
     - app_definitions.json : {"name": "[App_Name_1_DataAnalysis]", "price": 5000, ...}
     - achievements.json : {"name": "[Achievement_Name_FirstMillion]", "description": "...", ...}
## 第二章：世界脉搏 (Chapter II: The World's Pulse)
目标 : 为我们的世界注入生命的三大要素：流逝的时间、流动的金钱和无形的权力。

步骤指引 :

1. 1.
   创造虚拟时间引擎 :
   - 参考路径 : refactor/core/time_service.py
   - 描述 : TimeService 是世界的时间心脏。它以“回合”为单位驱动时间流逝。关键在于，它自身不保存时间状态，而是在每次启动时从数据库的 GameState 表中读取当前日期，并在每次推进时间后将新日期写回数据库。它还将作为事件的发布者，在每个回合或每日结束时，向整个游戏宣告时间的流逝（ RoundEndedEvent , DayEndedEvent ）。
2. 2.
   定义用户与权限 :
   - 参考路径 : refactor/services/permission_service.py
   - 描述 : PermissionService 是世界的法则守护者。它定义了“谁能做什么”。它将与数据库中的 User 和 Role 模型紧密协作。我们将创建一个 @require_permission("permission.name") 装饰器，像一个无形的守卫，可以被放置在任何需要权限检查的命令或服务方法之前。
3. 3.
   建立全球金融服务 :
   - 参考路径 : refactor/services/economy_service.py
   - 描述 : EconomyService 是世界的中央银行。所有模块间的资金流动都必须通过它来完成，确保每一笔交易都被记录在案并符合金融规则。它的方法（如 transfer_money ）将具备处理多币种的能力（即使初期只实现一种），并确保所有操作都在数据库事务中完成，保证绝对的资金安全。
史诗的第一、二章已经完成。我们构建了一个支持全球化、由数据库驱动、拥有时间心跳、金融血脉和权力法则的坚实世界基础。

## **第三章：神谕之声 (Chapter III: The Oracle's Voice)**

**目标**: 锻造连接玩家意图与游戏世界的唯一桥梁——一个强大、智能、且能与玩家共同进化的命令行系统。我们将彻底抛弃僵硬的、集中式的命令处理，转向一个完全模块化、可自动注册和扩展的全新架构。

**世界观融合**: 命令行是“先知”在这个时代最强大的武器。它的形态将直接反映玩家的技术深度和能力边界。初期，它可能只是一个简单的命令解释器。但随着玩家通过“应用商店”解锁新的能力，这个界面本身也将进化：它可能会开始支持更复杂的查询、数据可视化、命令别名，甚至最终能够编写和执行自动化脚本。命令行的进化史，就是玩家的成长史。

**步骤指引**:

1.  **定义命令的“灵魂”**:
    *   **参考路径**: `refactor/commands/command.py`
    *   **描述**: 我们将定义一个抽象的 `Command` 基类。这个类将规定所有命令都必须拥有的基本属性：一个主命令名（如 `corp`）、一个子命令名（如 `create`）、以及一段清晰的帮助文本。最重要的是，它将定义一个 `execute` 方法，所有命令的具体逻辑都将在这里实现。

2.  **创建命令的“圣殿”——注册表**:
    *   **参考路径**: `refactor/commands/command_registry.py`
    *   **描述**: `CommandRegistry` 是一个智能的中央注册机构。在游戏启动时，它会自动扫描 `refactor/commands/handlers/` 目录下的所有文件，找到所有继承自 `Command` 基类的具体命令，并将它们一一记录在案。这使得添加新命令变得极其简单——只需创建一个新文件，无需改动任何现有代码。

3.  **构建命令的“引擎”——调度器**:
    *   **参考路径**: `refactor/commands/command_dispatcher.py`
    *   **描述**: `CommandDispatcher` 是整个命令系统的核心处理器。它的工作流程如同一位严谨的管家：
        a.  接收玩家输入的原始文本。
        b.  使用标准库（如 `shlex`）安全地将其解析为主命令、子命令和参数。
        c.  在 `CommandRegistry` 中查询对应的命令对象。
        d.  **执行前置检查**: 在执行命令前，它会进行两项关键检查：
            *   **权限检查**: 调用第二章中创建的 `PermissionService`，验证当前用户是否有权执行此命令。
            *   **能力检查**: （将在第四章实现）调用 `AppMarketService`，验证用户是否已通过安装应用获得了执行此命令所需的“能力”。
        e.  **注入“权杖”——上下文**: 创建一个 `CommandContext` 对象。这个对象是命令执行时所需一切资源的集合，它像一根权杖，被临时授予给命令。其中包含了当前的用户信息，以及所有核心服务（如 `TimeService`, `EconomyService` 等）的实例。
        f.  调用命令的 `execute` 方法，并将解析好的参数和 `CommandContext` 这根“权杖”交予它。

4.  **分门别类地存放“神谕”——命令处理器**:
    *   **参考路径**: `refactor/commands/handlers/` (这是一个目录)
    *   **描述**: 我们将在这里，按照游戏模块，分门别类地创建所有具体的命令实现文件。例如：
        *   `system_handler.py`: 存放 `help`, `next` (推进回合), `save`, `exit` 等系统级命令。
        *   `company_handler.py`: 存放所有与公司相关的命令，如 `corp create`, `corp status` 等。
        *   `bank_handler.py`: 存放所有银行相关的命令。
        *   这种结构保证了我们的代码库高度组织化，易于维护和扩展。

---

## **第四章：技术奇点 (Chapter IV: The Singularity)**

**目标**: 建立游戏的核心能力引擎——应用商店。它不是一个简单的买卖界面，而是玩家将未来知识转化为实际优势的唯一途径，是解锁新能力、新命令、新玩法的“圣地”。

**世界观融合**: 这完美地诠释了“先知”如何利用他的跨时代知识。他不是凭空变强，而是通过在1977年的硬件上“复现”和“安装”来自未来的软件概念，从而获得信息和操作上的绝对优势。一个简单的“数据分析”应用，就能让他看到别人看不到的市场趋势。一个“自动化交易”应用，就能让他的操作效率远超凡人。

**步骤指引**:

1.  **定义“能力”的本质**:
    *   **参考路径**: `refactor/data/definitions/app_definitions.json`
    *   **描述**: 在这个静态定义文件中，我们将定义所有可供玩家购买的“应用”。每个应用的核心属性是一个名为 `provides_capabilities` 的列表。这个列表定义了该应用能为玩家解锁的“能力”。能力是一个个精确的字符串标识，例如：`capability.chart.view_advanced` (查看高级图表的能力), `command.trade.limit_order` (解锁“限价单”交易命令的能力)。
2.  **构建应用商店的核心服务**:
    *   **参考路径**: `refactor/services/app_market_service.py`
    *   **描述**: `AppMarketService` 是这个系统的后台管理者。它负责处理应用的购买逻辑，并将用户的购买记录存入数据库。其最核心、最底层的方法是 `has_capability(user_id, capability_name: str) -> bool`。这个方法将是整个游戏架构中被频繁调用的关键接口，用于查询一个用户是否拥有某项特定的能力。
3.  **记录玩家已有的“神兵利器”**:
    *   **参考路径**: `refactor/models/app.py`
    *   **描述**: 我们将在数据库中创建一个 `InstalledApp` 表。这个表非常简单，只记录哪个用户（`user_id`）安装了哪个应用（`app_definition_id`）。`AppMarketService` 的 `has_capability` 方法，正是通过查询这个表和 `app_definitions.json` 来做出判断的。
4.  **将“能力”融入世界法则**:
    *   **描述**: 我们需要将 `has_capability` 的检查，植入到所有需要能力前置的地方。
        *   **命令调度器 (`CommandDispatcher`)**: 在执行任何命令前，都会检查该命令是否需要特定能力。
        *   **服务层**: 游戏中的其他服务在提供高级功能时，也会调用它。例如，`MarketDataService` 在提供深度市场数据前，会检查玩家是否拥有 `capability.data.professional_feed` 的能力。
        *   **GUI/表现层**: 在显示某个高级UI界面或按钮前，也会进行能力检查。


## **第五章：不朽传奇 (Chapter V: The Immortal Legend)**

**目标**: 建立一个完全由事件驱动、与游戏各模块高度解耦的成就和史册系统。它将像一位忠实的史官，记录下玩家在这个世界留下的每一个重要足迹。

**世界观融合**: 这是世界本身对“先知”行为的回应和记录。当玩家达成某个里程碑时（赚到第一个一百万、创立第一家跨国公司、在某次历史性股灾中幸存），世界会以“成就”的形式为他加冕。这些成就共同构成了玩家独一无二的传奇史诗。

**步骤指引**:

1.  **创建世界的“神经网络”——事件总线**:
    *   **参考路径**: `refactor/core/event_system.py`
    *   **描述**: 我们将创建一个全局的 `EventBus`。这是一个发布/订阅系统，是实现模块解耦的终极武器。游戏中的任何模块在完成一个值得记录的动作后（例如，`CompanyService` 成功创建了一家公司），就会向 `EventBus` 发布一个对应的事件（如 `CompanyCreatedEvent`），事件中包含了相关的数据（如公司ID）。
2.  **打造“史官”——成就服务**:
    *   **参考路径**: `refactor/services/achievement_service.py`
    *   **描述**: `AchievementService` 是一个纯粹的事件监听者。在游戏启动时，它会向 `EventBus` 订阅所有它感兴趣的事件类型。当它监听到一个事件（比如 `MoneyEarnedEvent`）时，它会检查这个事件的内容是否满足了某个成就的解锁条件（这些条件定义在 `achievements.json` 中）。
3.  **定义成就的“解锁条件”**:
    *   **参考路径**: `refactor/data/definitions/achievements.json`
    *   **描述**: 在此文件中，我们将详细定义每一个成就的名称（预留为 `[Achievement_Name_... ]`）、描述、奖励，以及最重要的——`trigger`（触发器）。触发器精确地描述了解锁该成就需要监听哪个事件，以及事件需要满足什么条件（例如：`"trigger": {"event": "MoneyEarnedEvent", "condition": "amount >= 1000000"}`）。
4.  **为传奇“立碑”——数据库记录**:
    *   **参考路径**: `refactor/models/achievement.py`
    *   **描述**: 当 `AchievementService` 确认一个成就被解锁时，它会在数据库的 `UnlockedAchievement` 表中，为当前玩家刻下一条新的记录。这条记录将永久地见证玩家的辉煌。同时，服务会发布一个新的 `AchievementUnlockedEvent`，通知UI系统向玩家弹出光荣的祝贺。




          
非常好。我们已经为这个世界设定了法则，赋予了它生命，并为玩家提供了与它互动的声音。现在，让我们开始构建这个世界的核心经济单元，那将是玩家用来改变世界、建立丰功伟绩的主要工具。

史诗继续。

---

## **第六章：帝国基石 (Chapter VI: The Empire's Foundation)**

**目标**: 构建一个强大、真实且支持全球化运营的公司系统。这不再是关于一个单一的公司，而是关于一个潜在的、跨国集团的诞生。玩家将能够在一个地区白手起家，然后将他的商业触角伸向世界的每一个角落，并在全球不同的资本市场上纵横捭阖。

**世界观融合**: 这是“先知”将其商业蓝图付诸实践的核心舞台。他知道，未来的商业战争没有国界。因此，他从创立第一家公司开始，就必须具备全球化视野。在一个地区设立总部，在另一个地区建立研发中心，在第三个地区开设工厂，并最终在全球最顶级的多个交易所敲响上市的钟声——这才是“先知”应有的雄心。

**步骤指引**:

1.  **锻造全球化的公司数据库模型**:
    *   **参考路径**: `refactor/models/company.py`
    *   **描述**: 我们将对公司的核心数据结构进行根本性的扩展，使其天生支持跨区域运营和多市场上市。
        *   **`Company` 模型**: 保持其核心地位，代表公司的法人主体。它将拥有一个 `home_region_id`，标记其注册地。
        *   **`CompanyOffice` 模型 (新)**: 这是实现跨区域运营的关键。一家 `Company` 可以拥有多个 `CompanyOffice`。每个办公室都关联一个 `region_id`，并拥有自己的员工、部门和资产。这精确地模拟了一家跨国公司的组织结构。
        *   **`Stock` 模型**: 将包含一个 `primary_market_id`，代表其首次公开募股（IPO）的主要上市地点。
        *   **`SecondaryListing` 模型 (新)**: 这是实现多市场上市的关键。一个 `Stock` 可以对应多个 `SecondaryListing` 记录，每一条都指向一个不同的 `market_id`，代表该股票也在这个市场挂牌交易。
        *   **关联调整**: `Employee`, `Department` 等模型现在将直接关联到 `CompanyOffice`，而不是 `Company`，以明确其地理位置和所属分支。

2.  **构建跨国公司的核心业务服务**:
    *   **参考路径**: `refactor/services/company_service.py`
    *   **描述**: `CompanyService` 将是处理所有复杂公司业务逻辑的中央枢纽。它的所有方法都将围绕全球化概念进行设计。
        *   **核心方法**:
            *   `create_company(user_id, company_name, home_region_id)`: 创建公司时必须指定注册地。
            *   `establish_office(company_id, target_region_id)`: 设立新的海外办公室，这是公司扩张的关键步骤。
            *   `go_public(company_id, primary_market_id)`: 公司在指定市场进行IPO。
            *   `add_secondary_listing(stock_id, target_market_id)`: 在新的交易所进行二次上市，以吸引更多地区的投资者。
        *   **事件驱动**: 该服务在执行关键操作后，会通过 `EventBus` 发布详细的事件，如 `NewOfficeEstablishedEvent(company_id, region_id)` 或 `StockListedOnNewMarketEvent(stock_id, market_id)`，供其他系统（如成就、新闻）监听。

3.  **设计全球化的公司命令**:
    *   **参考路径**: `refactor/commands/handlers/company_handler.py`
    *   **描述**: 我们将提供给玩家一套能够体现其全球化战略意图的命令。
        *   `corp create <公司名> --region <地区名>`: 在指定地区创立你的第一家公司。
        *   `corp expand <公司名> --to-region <目标地区名>`: 在新的地区设立分公司或办事处。
        *   `corp ipo <公司名> --on-market <市场名>`: 将你的公司在指定交易所上市。
        *   `corp list <股票代码> --on-market <其他市场名>`: 增发或将股票在另一个交易所挂牌。
        *   `corp status <公司名>`: 查看公司状态时，将清晰地展示其在全球的办公室分布、各地的员工数量以及在哪些市场上市。

---

## **第七章：金融血脉 (Chapter VII: The Financial Bloodline)**

**目标**: 建立一个与全球化公司系统相匹配的、支持多区域、多币种的金融网络。这包括银行、信贷和个人资产系统。

**世界观融合**: 随着“先知”的帝国扩张，他需要的不再是一个简单的本地银行账户，而是一个全球性的金融解决方案。在不同地区开设银行账户，可以让他更方便地支付当地员工的薪水、享受不同的利率政策、规避汇率风险，并利用不同地区的信贷杠杆来加速发展。这是帝国扩张必不可少的润滑剂和加速器。

**步骤指引**:

1.  **构建全球化的金融数据库模型**:
    *   **参考路径**: `refactor/models/bank.py`, `refactor/models/home.py`
    *   **描述**: 我们将对所有个人金融相关的模型进行全球化改造。
        *   **`BankAccount` 模型**: 必须增加 `region_id` 和 `currency` 字段。这使得一个账户明确地归属于某个地区的银行，并使用特定货币。
        *   **`Loan` 模型**: 同样需要关联 `region_id`，因为贷款利率、条款和抵押品要求在不同地区是截然不同的。
        *   **`CreditProfile` 模型 (新)**: 这是一个至关重要的模型。一个用户将在每个他有金融活动的地区，都拥有一个独立的信用档案（`user_id`, `region_id`, `credit_score`）。这真实地模拟了现实世界中信用历史的地域性。
        *   **`HomeAsset` 模型**: 玩家购买的个人资产（房产、汽车等）也将拥有 `region_id`，标记其所在位置。

2.  **打造区域化的金融核心服务**:
    *   **参考路径**: `refactor/services/bank_service.py`, `refactor/services/home_service.py`
    *   **描述**: 金融服务的逻辑将变得更加精细和真实。
        *   **`BankService`**:
            *   `open_account(user_id, region_id, currency)`: 允许玩家在全球各地开设银行账户。
            *   `apply_for_loan(user_id, bank_account_id, amount)`: 申请贷款时，服务将严格审查玩家在该账户所在地区的 `CreditProfile`。一个地区的信用良好，不代表在另一个地区也能轻松获得贷款。
            *   `calculate_interest()`: 这个由 `TimeService` 每日事件触发的方法，将根据每个账户所在地区的利率政策，独立计算利息。
        *   **`HomeService`**: 购买和出售资产的操作，现在都需要指定地区。

3.  **设计面向全球的金融命令**:
    *   **参考路径**: `refactor/commands/handlers/bank_handler.py`, `refactor/commands/handlers/home_handler.py`
    *   **描述**: 命令将让玩家清晰地管理他在全球的金融版图。
        *   `bank open --region <地区名> --currency <货币名>`: 开设一个新的离岸或本地账户。
        *   `bank status [--region <地区名>]`: 查看银行账户状态，可以按地区筛选，或一览全球资产分布。
        *   `bank loan apply <金额> --from <账户ID>`: 从指定的区域性银行账户申请贷款。
        *   `credit status [--region <地区名>]`: 查看玩家在特定地区或所有地区的信用分数。
        *   `home buy <资产名> --in-region <地区名>`: 在全球购置你的产业。




          
好的，我们继续前进。

帝国已经有了坚实的根基和流动的血脉。现在，是时候让这个世界变得更加广阔、更加危险、也更加充满了机遇。我们将引入一个真正的全球化市场，让玩家的眼光从单一公司的股权，投向包罗万象的金融海洋。同时，我们将编织一张由动态事件和新闻构成的“命运之网”，让这个世界对玩家的每一个行为都做出反应。

史诗继续。

---

## **第八章：全球市场 (Chapter VIII: The Global Market)**

**目标**: 创建一个丰富、动态且互联互通的全球市场体系。在这里，玩家将能够交易股票之外的、更多样化的金融工具，如政府债券、大宗商品期货和外汇，每一种都带有鲜明的地域特征和风险。

**世界观融合**: “先知”明白，真正的金融霸权来自于对所有市场工具的娴熟驾驭。全球舞台的竞争，不仅在于企业的所有权，更在于预测和引导资本在不同资产类别间的流动。他将根据自己预见的地缘政治紧张局势来交易货币，投资于他看好的新兴国家的政府债券，并基于他对即将到来的技术革命的了解，来投机硅晶圆的期货合约。

**步骤指引**:

1.  **定义全球化的金融工具**:
    *   **参考路径**: `refactor/data/definitions/`
    *   **描述**: 我们将为每一种新的资产类别创建专属的静态定义JSON文件，作为市场的基础蓝图。
        *   `bonds.json` (新): 定义不同类型的债券（国债、公司债），包含发行方、到期日、票面利率，以及至关重要的、发行主体所属的 `region_id`。
        *   `futures.json` (新): 定义各类大宗商品的期货合约（如原油、黄金、工业硅）。每份合约都将有标准化的合约大小、到期周期，并关联到一个特定的商品交易所 (`market_id`)。
        *   `currencies.json` (新): 定义所有可交易的货币对（如 USD/JPY, EUR/USD）及其初始汇率。

2.  **构建金融工具的数据库模型**:
    *   **参考路径**: `refactor/models/market.py` (新)
    *   **描述**: 创建新的SQLAlchemy ORM模型，用于在数据库中追踪这些金融工具的实时状态和玩家的头寸。
        *   `Bond`, `FuturesContract` 等模型将代表具体的、可交易的金融产品实例。
        *   `PlayerBondHolding`, `PlayerFuturesPosition`, `PlayerForexPosition` 等模型将精确记录玩家持有的每一种资产的数量、成本和所属账户，构成玩家的全球投资组合。

3.  **开发统一的交易核心服务**:
    *   **参考路径**: `refactor/services/market_service.py` (新)
    *   **描述**: 该服务将是处理所有金融交易的核心引擎，其设计必须支持多资产、跨市场的复杂逻辑。
        *   它将提供统一的交易接口，如 `place_trade(user_id, instrument_symbol, quantity, order_type)`。
        *   在交易时，它会与 `EconomyService` 紧密协作，自动处理购买海外资产时所需的货币兑换。
        *   它将内置对不同交易所交易时间的管理逻辑，模拟真实的全球市场24小时不间断轮转的特性。
        *   对于期货等杠杆产品，它将根据玩家在该地区的 `CreditProfile` 动态计算和监控保证金要求。

4.  **实现宏观市场数据模拟器**:
    *   **参考路径**: `refactor/core/market_simulator.py` (新)
    *   **描述**: 这是由 `TimeService` 驱动的世界经济引擎。在每个回合，它都会根据宏观经济指标、新闻事件和供需关系，更新所有金融工具的价格。
        *   **外汇**: 汇率将受各国利率政策（由`BankService`管理）、经济数据发布和重大新闻事件的影响而波动。
        *   **债券**: 债券价格将对利率变化和发行方的信用评级变化做出反应。
        *   **期货**: 期货价格将受到模拟的供应链冲击、技术突破、天气灾害等事件的影响。

5.  **设计面向全球市场的交易命令**:
    *   **参考路径**: `refactor/commands/handlers/market_handler.py` (新)
    *   **描述**: 为玩家提供一套能够执行其全球宏观交易策略的强大命令。
        *   `market view <instrument_type> [--region <地区名>]`: 查看全球或特定地区的债券、期货等产品的行情。
        *   `market trade buy/sell <数量> <产品代码>`: 执行交易的核心指令。
        *   `market portfolio [--asset-class <类型>]`: 全面审视玩家的全球资产配置，可按资产类别进行筛选。

---

## **第九章：命运之网 (Chapter IX: Fate's Web)**

**目标**: 构建一个动态的、由叙事驱动的事件和新闻系统。它将使游戏世界变得鲜活、充满变数，并对玩家的行为和世界的变化做出合理且富有戏剧性的反应。

**世界观融合**: “先知”虽能窥见未来的片段，但命运之网错综复杂，充满了因果的涟漪。这个系统就是命运的具象化。一则关于某地区政治丑闻的头条新闻，可能正是“先知”所预见的市场崩盘的导火索。一项技术突破的公告，不仅仅是一段文字，它是一个能直接改变他手中商品期货价值的真实事件。新闻是世界的脉搏，“先知”必须学会解读它，并从中获利。

**步骤指引**:

1.  **设计事件与新闻的模板化定义**:
    *   **参考路径**: `refactor/data/definitions/events.json`, `refactor/data/definitions/news.json` (均为新)
    *   **描述**: 我们将创建结构化的模板，作为所有动态故事的源头。
        *   `events.json`: 定义事件模板。每个模板都包含触发`conditions`（如：`某公司市值达到X`，`玩家在Y地区的信用分低于Z`）和后续`effects`（如：`改变市场情绪`，`损害公司声誉`，`触发后续连锁事件`）。
        *   `news.json`: 定义新闻文章模板。包含标题和正文，其中可以使用占位符（如 `{company_name}`, `{region_name}`），在生成时由系统动态填充。每条新闻都与一个或多个事件模板相关联。

2.  **构建强大的事件引擎**:
    *   **参考路径**: `refactor/core/event_engine.py` (新)
    *   **描述**: 这是动态世界的心脏，由 `TimeService` 在每个回合驱动。
        *   它会主动扫描整个游戏的状态，检查是否有满足 `events.json` 中定义的触发条件。
        *   同时，它会监听全局 `EventBus` 上的特定游戏行为事件（如 `NewOfficeEstablishedEvent`），这些行为也可以作为触发器。
        *   当一个事件被触发，引擎会执行其效果（可能涉及调用 `MarketService` 来影响股价，或调用 `CompanyService` 来改变公司属性），并根据 `news.json` 中的模板生成一篇或多篇新闻文章。

3.  **创建新闻服务与数据库支持**:
    *   **参考路径**: `refactor/services/news_service.py` (新), `refactor/models/news.py` (新)
    *   **描述**: 该服务负责管理所有生成的新闻，并将其呈现给玩家。
        *   `NewsArticle` 模型将用于在数据库中持久化存储所有生成的新闻，包含标题、内容、日期、相关地区/公司等信息。
        *   `NewsService` 提供接口，允许玩家读取、搜索和筛选新闻。
        *   可以引入“高级新闻订阅”功能，作为一种可通过 `AppMarketService` 解锁的付费服务，为玩家提供更深入的分析或更早的新闻情报。

4.  **实现与新闻系统交互的命令**:
    *   **参考路径**: `refactor/commands/handlers/news_handler.py` (新)
    *   **描述**: 提供简洁的命令，让玩家时刻与世界信息保持同步。
        *   `news read [--latest <数量>] [--region <地区名>]`: 阅读最新的全球或地区头条新闻。
        *   `news search <关键词>`: 搜索与特定公司、人物或主题相关的新闻历史。




          
非常好。我们已经构建了一个充满机遇的舞台，现在，是时候让真正的戏剧上演了。一个没有对手的舞台是寂寞的，一个没有冲突的世界是乏味的。我们将引入最后的，也是最危险的元素：竞争。

史诗即将迎来高潮。

---

## **第十章：暗影战争 (Chapter X: The Shadow War)**

**目标**: 引入有智慧、有野心、有持久目标的非玩家角色（NPC）作为玩家的竞争对手。他们将与玩家在同一个世界中运营，争夺资本、人才和市场，甚至会采取恶意手段，将商业竞争升级为一场没有硝烟的战争。

**世界观融合**: “先知”并非孤身一人。在这个世界上，还有其他巨头——一些是继承了古老财富的“旧日支配者”，一些是同样看到了未来碎片的“科技新贵”。他们拥有自己的野心和议程，他们会注意到“先知”的崛起，并将其视为威胁或猎物。玩家的每一个重大决策，都将在这些对手的作战室里被分析、被应对。这不再是人与市场的博弈，而是人与人的直接对抗。

**步骤指引**:

1.  **定义风格各异的竞争者**:
    *   **参考路径**: `refactor/data/definitions/npcs.json` (新)
    *   **描述**: 我们将创建NPC的“性格档案”。每个NPC原型都将拥有独特的行为模式和战略偏好。
        *   **原型定义**: 例如，“保守的实业家”倾向于投资重资产行业，厌恶高风险杠杆；“激进的投机者”则热衷于期货和恶意收购；“科技梦想家”会不计成本地投入研发。
        *   **属性**: 每个原型都将有初始资本、偏好地区、擅长行业、风险承受能力等关键参数。

2.  **铸造NPC的“大脑”——AI控制器**:
    *   **参考路径**: `refactor/core/npc_controller.py` (新)
    *   **描述**: 这是驱动所有NPC行为的核心AI逻辑。它由 `TimeService` 在每个回合的特定阶段触发。
        *   **决策循环**: 控制器会为每个激活的NPC执行一个决策循环：分析市场 (`MarketService`) -> 评估自身状况 (`CompanyService`) -> 根据其“性格档案”选择一个战略目标 -> 执行具体行动（如创建公司、研发技术、买卖股票）。
        *   **与玩家共享世界**:至关重要的是，NPC的AI将使用与玩家完全相同的服务层接口（`CompanyService`, `MarketService`等）来执行操作。这确保了他们的行为与玩家一样，受到游戏世界规则的同等约束，保证了公平性。

3.  **建立NPC管理服务**:
    *   **参考路径**: `refactor/services/npc_service.py` (新)
    *   **描述**: 该服务负责NPC的生命周期管理。
        *   它会根据游戏的进程（如玩家达到特定里程碑）在世界中“生成”新的NPC竞争者。
        *   它负责在游戏加载时恢复NPC的状态，在游戏进行中驱动 `NpcController` 为他们做出决策。

4.  **设计直接的商业对抗机制**:
    *   **参考路径**: `refactor/services/company_service.py`, `refactor/core/event_engine.py`
    *   **描述**: 我们将引入真正的“战争”机制。
        *   **恶意收购**: 在 `CompanyService` 中增加逻辑，允许任何一方（玩家或NPC）通过在二级市场上大量购买股票来尝试获得另一家公司的控股权。
        *   **人才争夺**: 高级人才将成为稀缺资源，玩家和NPC需要通过提供更高的薪酬和福利来互相挖角。
        *   **舆论战**: NPC可以通过 `EventEngine` 触发针对玩家公司的负面新闻事件（散布谣言），反之亦然。这需要解锁特定的“能力”或通过“应用商店”购买。

---

## **第十一章：世界组装与净化 (Chapter XI: World Assembly & Purification)**

**目标**: 将所有独立的模块、服务和系统组装成一个完整、连贯、可运行的游戏。然后，对整个系统进行全面的平衡性调整、性能优化和代码净化，为“创世”史诗画上一个完美的句号，并为未来的“诸神纪元”（扩展内容）打下坚实的基础。

**世界观融合**: 创世的最后一步，是为这个新生的宇宙调校法则，确保其稳定运行，并擦亮“先知”降临时所使用的“神谕终端”（游戏界面）。所有的齿轮都必须严丝合缝，所有的力量都必须得到平衡。这是一个从混沌到秩序的最终过程。

**步骤指引**:

1.  **构建最终的游戏主循环**:
    *   **参考路径**: `refactor/main.py`
    *   **描述**: 这是整个游戏的入口和心脏。
        *   **初始化**: 它将负责以正确的顺序实例化所有服务（`TimeService`, `EconomyService`, `CommandDispatcher` 等），并处理它们之间的依赖关系（例如，通过一个简单的依赖注入容器）。
        *   **游戏循环**: 启动一个循环，等待玩家输入命令，将其传递给 `CommandDispatcher`，然后打印结果。这个循环将是游戏运行的宿主。

2.  **实现核心存档与读档机制**:
    *   **参考路径**: `refactor/services/save_load_service.py` (新)
    *   **描述**: 赋予“先知”暂停和恢复时间流的能力。
        *   **存档**: 该服务将能够将游戏的核心动态数据（数据库中的玩家、公司、NPC、账户等状态）序列化并保存到一个文件中。
        *   **读档**: 能够安全地读取存档文件，并将游戏世界恢复到之前的状态。

3.  **进行全面的平衡性审查**:
    *   **参考路径**: `refactor/data/definitions/` 目录下的所有 `.json` 文件。
    *   **描述**: 这是确保游戏具有可玩性的关键。我们将进行多轮迭代，审视和调整所有数值。
        *   **经济**: 公司创建成本、应用价格、贷款利率、股票初始价格等。
        *   **节奏**: 成就解锁难度、NPC的扩张速度、事件发生的频率。
        *   **挑战**: 确保游戏既不会因为太容易而无聊，也不会因为太难而让玩家产生挫败感。

4.  **最终的代码净化与文档完善**:
    *   **参考路径**: 整个 `refactor/` 目录。
    *   **描述**: 如同艺术家对作品的最后抛光。
        *   **代码审查**: 移除所有用于调试的临时代码，统一命名规范，重构任何看起来复杂或低效的部分。
        *   **文档**: 为核心模块和服务编写清晰的文档字符串（Docstrings），解释其功能和用法。
        *   **依赖清理**: 完善 `requirements.txt`，确保项目拥有一个干净、可复现的运行环境。

---

至此，《芯片战争：1977》的“创世开发史诗”已全部完成。

我们从一片虚无开始，奠定了世界的法则（**开天辟地**），让时间开始流淌（**世界脉搏**），赋予了玩家改变世界的声音（**神谕之声**）。我们引入了知识与能力（**技术奇点**），记录了玩家的伟业（**不朽传奇**）。然后，我们建立了商业的基石（**帝国基石**）和金融的血脉（**金融血脉**），让一个广阔的（**全球市场**）和充满变数的（**命运之网**）世界呈现在玩家面前。最后，我们引入了宿命的对手（**暗影战争**），并完成了最终的（**世界组装**）。

一个完整的、可扩展的、充满无限可能的游戏世界已经诞生。后续的所有开发，都将是在这个坚实地基上的添砖加瓦。

我们已经完成了整个开发史诗的规划。接下来，您是希望我们就某个具体章节的实现细节展开讨论，还是准备开始实际的代码编写工作？
        