from commands.base import Command
from services.app_service import AppService
from typing import Dict, Any

class AppListCommand(Command):
    """åº”ç”¨åˆ—è¡¨å‘½ä»¤ - æ˜¾ç¤ºç”¨æˆ·æ‹¥æœ‰çš„åº”ç”¨"""
    
    def __init__(self, app_service: AppService):
        super().__init__()
        self.app_service = app_service
    
    def execute(self, args: list, context: Dict[str, Any]) -> str:
        user_id = getattr(context.user, 'user_id', None) if hasattr(context, 'user') and context.user else None
        if not user_id:
            return "âŒ è¯·å…ˆç™»å½•"
        
        if args and args[0].lower() == 'stats':
            return self._show_app_stats(user_id)
        
        return self._show_owned_apps(user_id)
    
    def _show_owned_apps(self, user_id: int) -> str:
        """æ˜¾ç¤ºç”¨æˆ·æ‹¥æœ‰çš„åº”ç”¨åˆ—è¡¨"""
        owned_app_names = self.app_service.get_user_owned_apps(user_id)
        available_apps = self.app_service.get_available_apps()
        
        # è·å–æ‹¥æœ‰çš„åº”ç”¨è¯¦æƒ…
        owned_apps = []
        free_apps = []
        
        for app in available_apps:
            if app['name'] in owned_app_names:
                owned_apps.append(app)
            elif app['price'] == 0:
                free_apps.append(app)
        
        output = []
        output.append("â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®")
        output.append("â”‚                    ğŸ“± æˆ‘çš„åº”ç”¨                              â”‚")
        output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
        
        if owned_apps:
            output.append("â”‚  ğŸ’° å·²è´­ä¹°åº”ç”¨                                              â”‚")
            output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
            
            total_spent = 0
            for app in owned_apps:
                price = app['price']
                total_spent += price
                rating_stars = "â­" * int(app.get('rating', 0))
                
                output.append(f"â”‚ {app['icon']} {app['display_name']:<25} {price:>6.2f} JCC {rating_stars} â”‚")
                output.append(f"â”‚   {app['description'][:50]:<50}   â”‚")
                output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
            
            output.append(f"â”‚ ğŸ’¸ æ€»èŠ±è´¹: {total_spent:.2f} JCC                                    â”‚")
            output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
        
        if free_apps:
            output.append("â”‚  ğŸ†“ å…è´¹åº”ç”¨ (å¯ç›´æ¥ä½¿ç”¨)                                    â”‚")
            output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
            
            for app in free_apps[:5]:  # åªæ˜¾ç¤ºå‰5ä¸ªå…è´¹åº”ç”¨
                rating_stars = "â­" * int(app.get('rating', 0))
                output.append(f"â”‚ {app['icon']} {app['display_name']:<25} å…è´¹    {rating_stars}     â”‚")
                output.append(f"â”‚   {app['description'][:50]:<50}   â”‚")
                output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
            
            if len(free_apps) > 5:
                output.append(f"â”‚ ... è¿˜æœ‰ {len(free_apps) - 5} ä¸ªå…è´¹åº”ç”¨                              â”‚")
                output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
        
        output.append("â”‚  ğŸ’¡ ä½¿ç”¨æç¤º                                                â”‚")
        output.append("â”‚  â€¢ app <åº”ç”¨å>      - è¿è¡Œåº”ç”¨                             â”‚")
        output.append("â”‚  â€¢ app list stats    - æŸ¥çœ‹åº”ç”¨ç»Ÿè®¡                        â”‚")
        output.append("â”‚  â€¢ market            - æµè§ˆåº”ç”¨å¸‚åœº                        â”‚")
        output.append("â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯")
        
        return "\n".join(output)
    
    def _show_app_stats(self, user_id: int) -> str:
        """æ˜¾ç¤ºåº”ç”¨ä½¿ç”¨ç»Ÿè®¡"""
        stats = self.app_service.get_app_usage_stats(user_id)
        
        output = []
        output.append("â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®")
        output.append("â”‚                    ğŸ“Š åº”ç”¨ç»Ÿè®¡                              â”‚")
        output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
        output.append(f"â”‚ ğŸ“± åº”ç”¨å¸‚åœºæ€»åº”ç”¨æ•°: {stats['total_apps']:>3}                          â”‚")
        output.append(f"â”‚ âœ… å·²æ‹¥æœ‰åº”ç”¨æ•°:     {stats['owned_apps']:>3}                          â”‚")
        output.append(f"â”‚ ğŸ†“ å…è´¹åº”ç”¨æ•°:       {stats['free_apps']:>3}                          â”‚")
        
        if stats['total_apps'] > 0:
            owned_percentage = (stats['owned_apps'] / stats['total_apps']) * 100
            free_percentage = (stats['free_apps'] / stats['total_apps']) * 100
            
            output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
            output.append(f"â”‚ ğŸ“ˆ æ‹¥æœ‰ç‡:           {owned_percentage:>5.1f}%                        â”‚")
            output.append(f"â”‚ ğŸ†“ å…è´¹åº”ç”¨å æ¯”:     {free_percentage:>5.1f}%                        â”‚")
        
        if stats['owned_app_names']:
            output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
            output.append("â”‚ ğŸ† å·²æ‹¥æœ‰çš„åº”ç”¨:                                            â”‚")
            
            for i, app_name in enumerate(stats['owned_app_names'], 1):
                output.append(f"â”‚ {i:>2}. {app_name:<54} â”‚")
        
        output.append("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
        output.append("â”‚ ğŸ’¡ ä½¿ç”¨ 'market' æµè§ˆæ›´å¤šåº”ç”¨                               â”‚")
        output.append("â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯")
        
        return "\n".join(output)
    
    def get_help(self) -> str:
        return """
åº”ç”¨åˆ—è¡¨å‘½ä»¤ - æŸ¥çœ‹æ‹¥æœ‰çš„åº”ç”¨

ç”¨æ³•:
  app list        - æ˜¾ç¤ºæ‹¥æœ‰çš„åº”ç”¨åˆ—è¡¨
  app list stats  - æ˜¾ç¤ºåº”ç”¨ä½¿ç”¨ç»Ÿè®¡

ç¤ºä¾‹:
  app list
  app list stats
"""